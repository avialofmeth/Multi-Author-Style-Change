They didn't really switch sides. They just had a non aggression pact with Germany. Also, when Hitler was rebuilding the german military, Stalin let him train troops and develop weapons he wasn't supposed to have in the USSR.